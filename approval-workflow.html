<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Summit Bank | Access Management Approval Portal</title>

  <!-- GOOGLE FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />

  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #f9f9f9 0%, #ffffff 100%);
      color: #333;
    }

    /* Top Navigation */
    .navbar {
      background: linear-gradient(135deg, #8B0000 0%, #B22222 100%);
      color: white;
      padding: 18px 30px;
      font-size: 20px;
      font-weight: 600;
      box-shadow: 0 3px 15px rgba(139, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .navbar::after {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      width: 150px;
      height: 100%;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.1) 100%);
    }

    /* Main Layout */
    .container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
    }

    .title {
      font-size: 28px;
      font-weight: 600;
      color: #8B0000;
      margin-bottom: 10px;
      text-align: center;
      position: relative;
      padding-bottom: 15px;
    }

    .title::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 3px;
      background: linear-gradient(90deg, transparent 0%, #8B0000 50%, transparent 100%);
    }

    /* Step Progress Bar */
    .steps {
      display: flex;
      justify-content: space-between;
      margin: 40px 0;
      position: relative;
    }

    .step {
      text-align: center;
      width: 33%;
      position: relative;
      z-index: 1;
    }

    .step .circle {
      width: 40px;
      height: 40px;
      background: #e0e0e0;
      border-radius: 50%;
      margin: 0 auto;
      line-height: 40px;
      font-weight: 600;
      color: #666;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .step.active .circle {
      background: #8B0000;
      color: white;
      box-shadow: 0 4px 10px rgba(139, 0, 0, 0.3);
    }

    .step.completed .circle {
      background: #8B0000;
      color: white;
      box-shadow: 0 4px 10px rgba(139, 0, 0, 0.3);
    }

    .step.completed .circle::after {
      content: "✓";
      font-weight: bold;
    }

    .step .label {
      margin-top: 8px;
      font-weight: 500;
      color: #555;
    }

    .step.active .label {
      color: #8B0000;
      font-weight: 600;
    }

    /* Divider Lines */
    .step:before, .step:after {
      content: "";
      position: absolute;
      top: 20px;
      height: 3px;
      background: #e0e0e0;
      width: 50%;
      z-index: -1;
      transition: all 0.3s ease;
    }

    .step:before {
      left: -50%;
    }

    .step:after {
      right: -50%;
    }

    .step:first-child:before {
      display: none;
    }

    .step:last-child:after {
      display: none;
    }

    .step.completed:before, .step.completed:after {
      background: #8B0000;
    }

    .step.active:before {
      background: #8B0000;
    }

    /* Approval Cards */
    .card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      margin-bottom: 25px;
      border-left: 4px solid #8B0000;
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }

    .card h3 {
      margin-top: 0;
      color: #8B0000;
      font-weight: 600;
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 10px;
    }

    .status {
      padding: 8px 15px;
      border-radius: 20px;
      display: inline-block;
      margin-bottom: 15px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .pending {
      background: #FFF3CD;
      color: #856404;
      border: 1px solid #FFEAA7;
    }

    .approved {
      background: #D4EDDA;
      color: #155724;
      border: 1px solid #C3E6CB;
    }

    .rejected {
      background: #F8D7DA;
      color: #721C24;
      border: 1px solid #F5C6CB;
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      border: none;
      margin-right: 10px;
      transition: all 0.3s ease;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .approve-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      box-shadow: 0 3px 8px rgba(40, 167, 69, 0.3);
    }

    .approve-btn:hover {
      background: linear-gradient(135deg, #218838 0%, #1e9e8a 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(40, 167, 69, 0.4);
    }

    .reject-btn {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
      box-shadow: 0 3px 8px rgba(220, 53, 69, 0.3);
    }

    .reject-btn:hover {
      background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(220, 53, 69, 0.4);
    }

    .comment-box {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      font-family: inherit;
      resize: none;
      transition: all 0.3s ease;
    }

    .comment-box:focus {
      outline: none;
      border-color: #8B0000;
      box-shadow: 0 0 0 2px rgba(139, 0, 0, 0.1);
    }

    /* Footer */
    .footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      color: #666;
      font-size: 14px;
      border-top: 1px solid #e0e0e0;
    }
  </style>
</head>

<body>

  <!-- NAVBAR -->
  <div class="navbar">Summit Bank — Access Management Approval Portal</div>

  <!-- MAIN CONTAINER -->
  <div class="container">

    <div class="title">Application Database Access — Approval Workflow</div>

    <!-- STEP PROGRESS -->
    <div class="steps" id="progressSteps"></div>

    <!-- APPROVAL CARDS -->
    <div id="approvalCards"></div>

    <div class="footer">
      Summit Bank &copy; 2025 | Secure Access Management System
    </div>

  </div>

  <script>
  let currentRequestId = 1; // You can make this dynamic based on URL parameters or user selection
  let approvalStages = [];

  // Load approval workflow from backend
  async function loadApprovalWorkflow(requestId = currentRequestId) {
    try {
      const response = await fetch(`http://localhost:5501/api/approvals/workflow/${requestId}`);
      if (response.ok) {
        const workflow = await response.json();
        approvalStages = workflow;
        renderSteps();
        renderCards();
      } else {
        console.error('Failed to load workflow');
        // Fallback to default stages if backend fails
        approvalStages = [
          { role: "User", status: "Pending", comment: "" },
          { role: "Admin", status: "Pending", comment: "" },
          { role: "Super_Admin", status: "Pending", comment: "" }
        ];
        renderSteps();
        renderCards();
      }
    } catch (error) {
      console.error('Error loading approval workflow:', error);
      // Fallback to default stages
      approvalStages = [
        { role: "User", status: "Pending", comment: "" },
        { role: "Admin", status: "Pending", comment: "" },
        { role: "Super_Admin", status: "Pending", comment: "" }
      ];
      renderSteps();
      renderCards();
    }
  }

  function renderSteps() {
    const stepsContainer = document.getElementById("progressSteps");
    stepsContainer.innerHTML = "";

    // Find the first pending stage, or if all are completed, show the last one as active
    let currentIndex = approvalStages.findIndex(stage => stage.status === "Pending");
    if (currentIndex === -1 && approvalStages.length > 0) {
      // All stages are completed, show the last one as active
      currentIndex = approvalStages.length - 1;
    }

    approvalStages.forEach((stage, index) => {
      let cls = "";
      if (stage.status === "Approved") {
        cls = "completed";
      } else if (stage.status === "Rejected") {
        cls = "rejected";
      } else if (index === currentIndex) {
        cls = "active";
      }

      stepsContainer.innerHTML += `
        <div class="step ${cls}">
          <div class="circle">${index + 1}</div>
          <div class="label">${stage.role.replace('_', ' ')}</div>
        </div>
      `;
    });
  }

  function renderCards() {
    const container = document.getElementById("approvalCards");
    container.innerHTML = "";

    approvalStages.forEach((stage, index) => {
      const isDisabled = stage.status !== "Pending";
      const displayStatus = stage.status === "Pending" ? "Pending" : 
                           stage.status === "Approved" ? "Approved" : "Rejected";
      
      container.innerHTML += `
        <div class="card">
          <h3>${stage.role.replace('_', ' ')} Approval</h3>

          <div class="status ${displayStatus.toLowerCase()}">
            Status: ${displayStatus}
          </div>

          <textarea 
            class="comment-box" 
            id="comment_${index}" 
            placeholder="Add comment..."
            ${isDisabled ? "readonly" : ""}
          >${stage.comment || ''}</textarea>

          <div>
            <button 
              class="btn approve-btn" 
              onclick="updateStatus(${index}, 'Approved')"
              ${isDisabled ? "disabled" : ""}
              style="${isDisabled ? 'opacity: 0.6; cursor: not-allowed;' : ''}"
            >
              Approve
            </button>
            <button 
              class="btn reject-btn" 
              onclick="updateStatus(${index}, 'Rejected')"
              ${isDisabled ? "disabled" : ""}
              style="${isDisabled ? 'opacity: 0.6; cursor: not-allowed;' : ''}"
            >
              Reject
            </button>
          </div>
        </div>
      `;
    });
  }

  async function updateStatus(index, status) {
    const comment = document.getElementById(`comment_${index}`).value;
    const role = approvalStages[index].role;
    
    try {
      // Show loading state
      const approveBtn = document.querySelector(`button[onclick="updateStatus(${index}, 'Approved')"]`);
      const rejectBtn = document.querySelector(`button[onclick="updateStatus(${index}, 'Rejected')"]`);
      
      if (approveBtn && rejectBtn) {
        approveBtn.disabled = true;
        rejectBtn.disabled = true;
        approveBtn.innerHTML = 'Processing...';
        rejectBtn.innerHTML = 'Processing...';
      }

      // Send to backend
      const response = await fetch("http://localhost:5501/api/approvals/update-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          request_id: currentRequestId,
          role: role,
          status: status,
          comment: comment,
          approver_name: "Current User", // Replace with actual user from authentication
          approver_email: "user@summitbank.com" // Replace with actual user email
        })
      });

      if (response.ok) {
        const result = await response.json();
        approvalStages = result.result;
        
        // Show success message
        showNotification(`Successfully ${status.toLowerCase()} the request!`, 'success');
        
        renderSteps();
        renderCards();
      } else {
        const errorData = await response.json();
        showNotification(`Error: ${errorData.error}`, 'error');
        
        // Re-enable buttons on error
        if (approveBtn && rejectBtn) {
          approveBtn.disabled = false;
          rejectBtn.disabled = false;
          approveBtn.innerHTML = 'Approve';
          rejectBtn.innerHTML = 'Reject';
        }
      }
    } catch (error) {
      console.error('Error updating approval status:', error);
      showNotification('Failed to update approval status. Please try again.', 'error');
      
      // Re-enable buttons on error
      const approveBtn = document.querySelector(`button[onclick="updateStatus(${index}, 'Approved')"]`);
      const rejectBtn = document.querySelector(`button[onclick="updateStatus(${index}, 'Rejected')"]`);
      if (approveBtn && rejectBtn) {
        approveBtn.disabled = false;
        rejectBtn.disabled = false;
        approveBtn.innerHTML = 'Approve';
        rejectBtn.innerHTML = 'Reject';
      }
    }
  }

  // Notification function
  function showNotification(message, type) {
    // Remove existing notifications
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
      existingNotification.remove();
    }

    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <div style="
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        ${type === 'success' ? 'background: linear-gradient(135deg, #28a745 0%, #20c997 100%);' : ''}
        ${type === 'error' ? 'background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);' : ''}
      ">
        ${message}
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Request selector (optional - for multiple requests)
  function addRequestSelector() {
    const titleElement = document.querySelector('.title');
    const selectorHTML = `
      <div style="text-align: center; margin-bottom: 20px;">
        <label for="requestSelect" style="font-weight: 500; margin-right: 10px;">Select Request:</label>
        <select id="requestSelect" onchange="changeRequest(this.value)" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #e0e0e0;">
          <option value="1">Request #1 - Application Database Access</option>
          <option value="2">Request #2 - Customer Data Access</option>
          <option value="3">Request #3 - Transaction Logs Access</option>
        </select>
      </div>
    `;
    titleElement.insertAdjacentHTML('afterend', selectorHTML);
  }

  async function changeRequest(requestId) {
    currentRequestId = parseInt(requestId);
    await loadApprovalWorkflow(currentRequestId);
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    // Add request selector (optional)
    addRequestSelector();
    
    // Load initial workflow
    loadApprovalWorkflow();
    
    // Add some CSS for the notification
    const style = document.createElement('style');
    style.textContent = `
      .notification {
        animation: slideIn 0.3s ease-out;
      }
      
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      .step.rejected .circle {
        background: #dc3545 !important;
        color: white;
      }
      
      .step.rejected .label {
        color: #dc3545 !important;
      }
    `;
    document.head.appendChild(style);
  });
</script>
</body>
</html>